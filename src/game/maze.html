<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta content="width=device-width,initial-scale=1.0" name="viewport"> <title>迷宫</title> <script src="https://cdn.wilddog.com/sdk/js/2.5.17/wilddog.js"></script> <script src="https://cdn.bootcss.com/pako/1.0.5/pako.min.js"></script> <script src="https://cdn.bootcss.com/crypto-js/3.1.9/core.min.js"></script> <script src="https://cdn.bootcss.com/crypto-js/3.1.9/sha1.min.js"></script> <link href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"> <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script> <script src="https://cdn.bootcss.com/moment.js/2.19.4/moment.min.js"></script> <script src="https://cdn.bootcss.com/moment.js/2.19.4/locale/zh-cn.js"></script> <style media="screen"> html, body{ padding: 0px; margin: 0px; overflow: hidden; } .table_body tr th,.table_body tr td{ vertical-align: inherit; } </style> </head> <body> </body> <script type="text/javascript"> "use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),Ranking=function(){function t(e){_classCallCheck(this,t),this.app=e,this.el=$(this.template()),$("body").append(this.el),this.mainBtn=$('<button type="button" class="main_btn btn btn-light m-3 fixed-top" style="left:auto;">PHB</button>'),$("body").append(this.mainBtn),this.tBody=this.el.find(".table_body"),this.tBtns=this.el.find(".win, .steps, .login, .update, .register"),this.init()}return _createClass(t,[{key:"init",value:function(){var t=this,e=this.el,i=this.mainBtn,s=(this.tBody,this.tBtns);this.app;i.click(function(){e.toggleClass("invisible"),t.update()}),s.click(function(e){s.removeClass("active"),$(e.target).addClass("active"),t.update()})}},{key:"update",value:function(){var t=(this.el,this.mainBtn,this.tBody,this.tBtns),e=this.app,i=[],s=[e.role.data];for(var a in Player.playerMap)s.push(Player.playerMap[a].data);s.sort(function(e,i){return t.hasClass("win active")?i.win-e.win:t.hasClass("steps active")?i.step-e.step:t.hasClass("login active")?i.login-e.login:t.hasClass("update active")?i.update-e.update:t.hasClass("register active")?i.register-e.register:i.win-e.win});for(var n=0;n<s.length;n++){var r=s[n];i.push('<tr><th scope="row">'+(n+1)+'</th>\n                     <td><img class="rounded-circle" src="https://www.gravatar.com/avatar/'+r.sha1+'?s=40&d=monsterid&from=rank"></td>\n                     <td class="text-left pl-3">'+r.name+"</td>\n                     <td>"+r.win+"</td> <td>"+r.step+"</td>\n                     <td>"+r.login+"</td>\n                     <td>"+moment(r.update).format("YYYY-MM-DD HH:mm:ss")+"</td>\n                     <td>"+moment(r.register).format("YYYY-MM-DD HH:mm:ss")+"</td>\n                    </tr>")}this.tBody.html(i.join(""))}},{key:"template",value:function(){return'<div class="order_container invisible container-fulid fixed-top h-100 w-100 pt-5"\n          style="left: auto; background-color: rgba(10, 10, 10, 0.9);overflow-x:hidden;overflow-y:auto;">\n          <table class="table table-sm text-light table-hover text-center">\n            <thead>\n              <tr>\n                <th scope="col"><button type="button" class="btn btn-link text-light" disabled>NO.</button></th>\n                <th scope="col"><button type="button" class="btn btn-link text-light" disabled>HEAD</button></th>\n                <th class="text-left" scope="col"><button type="button" class="btn btn-link text-light" disabled>NAME</button></th>\n                <th scope="col"><button type="button" class="btn btn-link win">WIN</button></th>\n                <th scope="col"><button type="button" class="btn btn-link steps">STEPS</button></th>\n                <th scope="col"><button type="button" class="btn btn-link login">LOGIN</button></th>\n                <th scope="col"><button type="button" class="btn btn-link update">UPDATE</button></th>\n                <th scope="col"><button type="button" class="btn btn-link register">REGISTER</button></th>\n              </tr>\n            </thead>\n            <tbody class="table_body">\n            </tbody>\n          </table>\n          </div>'}}]),t}(),SizeUtil=function(){function t(e,i,s,a){var n=this;_classCallCheck(this,t);var r=[i,s,a,e];this.width=r[0],this.height=r[1],this.padding=r[2],this.app=r[3],this.countSize(),window.addEventListener("resize",function(){n.countSize(),n.app.sence.canvas.width=n.innerWidth,n.app.sence.canvas.height=n.innerHeight})}return _createClass(t,[{key:"countSize",value:function(){var t=[window.innerWidth,window.innerHeight];this.innerWidth=t[0],this.innerHeight=t[1];var e=(this.innerWidth-2*this.padding)/this.width,i=(this.innerHeight-2*this.padding)/this.height;this.step=parseInt(Math.min(e,i)),this.app.role&&(this.app.role.speed=this.step/400,this.app.role.posX=this.step*this.app.role.x,this.app.role.posY=this.step*this.app.role.y),this.app.dirty=!0}}]),t}(),Scene=function(){function t(e){_classCallCheck(this,t);var i=e.size,s=e.timer;this.app=e,this.size=i,this.timer=s,this.models=[],this.canvas=document.createElement("canvas"),this.level=0,this.initCanvas()}return _createClass(t,[{key:"addModel",value:function(t){this.models.push(t)}},{key:"render",value:function(){var t=this.models,e=this.g,i=this.size,s=this.app;s.dirty&&(e.clearRect(0,0,i.innerWidth,i.innerHeight),this.renderText(e),t.forEach(function(t){t.render(e)}),s.dirty=!1)}},{key:"renderText",value:function(t){var e=(this.models,this.size),i=(this.app,e.innerHeight/10);t.font=i+"px 华文彩云",t.fillStyle="rgba(33,33,33,0.3)";var s="迷  宫",a=t.measureText(s);t.fillText(s,(e.innerWidth-a.width)/2,e.innerHeight/2-2*i),s="第"+this.level+"关",a=t.measureText(s),t.fillText(s,(e.innerWidth-a.width)/2,e.innerHeight/2),s=""+this.app.role.name,a=t.measureText(s),t.fillText(s,(e.innerWidth-a.width)/2,e.innerHeight/2+2*i)}},{key:"initCanvas",value:function(){var t=this.canvas,e=this.size;this.g=t.getContext("2d"),document.body.append(t),t.width=e.innerWidth,t.height=e.innerHeight,t.style.background="#EEE"}}]),t}(),Maze=function(){function t(e){_classCallCheck(this,t);var i=e.size,s=e.timer,a=e.network;this.app=e,this.size=i,this.timer=s,this.network=a,this.walls=[],this.models=[],this.mazeAnimEnd=!1,this.init()}return _createClass(t,[{key:"init",value:function(){var t=this;document.body.addEventListener("keydown",function(e){t.mazeAnimEnd&&(t.role[e.code]=!0)}),document.body.addEventListener("keyup",function(e){t.role[e.code]=!1});var e=function(e){var i=e.gamma,s=e.beta;e.alpha;setTimeout(function(){if(t._lastGamma!=i||t._lastBeta!=s){var e=[t.app.size.innerWidth,t.app.size.innerHeight];if(e[0]>e[1]){var a=[i,-s];s=a[0],i=a[1]}t.role.ArrowLeft=i<-1,t.role.ArrowRight=i>1,t.role.ArrowUp=s<-1,t.role.ArrowDown=s>1,t._lastGamma=i,t._lastBeta=s}},10)};window.addEventListener("deviceorientation",e,!1)}},{key:"create",value:function(){this.walls=[];for(var t=this.walls,e=this.size,i=(this.network,e.width),s=e.height,a={},n=0;n<s;n++)for(var r=0;r<i;r++)a[r+"-"+n]={x:r,y:n,l:!0,t:!0,r:!0,b:!0};var o=[],h=a["0-0"];for(delete a["0-0"],h.l=!1,a[i-1+"-"+(s-1)].r=!1,t.push(h);;){var l=[],d=h.x,c=h.y;if(a[d-1+"-"+c]&&l.push(a[d-1+"-"+c]),a[d+"-"+(c-1)]&&l.push(a[d+"-"+(c-1)]),a[d+1+"-"+c]&&l.push(a[d+1+"-"+c]),a[d+"-"+(c+1)]&&l.push(a[d+"-"+(c+1)]),l.length>0){o.push(h);var p=h;h=l[parseInt(l.length*Math.random())],t.push(h),delete a[h.x+"-"+h.y],p.x-1==h.x&&(p.l=h.r=!1),p.x+1==h.x&&(p.r=h.l=!1),p.y-1==h.y&&(p.t=h.b=!1),p.y+1==h.y&&(p.b=h.t=!1)}else if(!(h=Math.random()>.9?o.shift():o.pop()))break}}},{key:"addRole",value:function(t){this.role=t,this.addModel(t)}},{key:"addModel",value:function(t){this.models.push(t)}},{key:"countState",value:function(){var t=this.walls,e=this.timer,i=this.app,s=e.startDelta;this.drawSize=s/5,this.drawSize>t.length+50?this.mazeAnimEnd=!0:(this.mazeAnimEnd=!1,i.dirty=!0)}},{key:"render",value:function(t){var e=this.models,i=this.size,s=(this.walls,this.mazeAnimEnd,this.role),a=this.network,n=(this.app,i.width),r=i.height,o=i.step,h=i.innerWidth,l=i.innerHeight;t.save(),t.translate((h-n*o)/2,(l-r*o)/2),this.drawWalls(t),s.gameover||(e.forEach(function(e){e.render(t)}),s.render(t)),t.restore(),s.gameover||s.isVictory()&&a.onVictory()}},{key:"drawPath",value:function(t){var e=(this.walls,this.drawSize,this.mazeAnimEnd),i=this.role,s=this.size,a=s.width,n=s.height,r=s.step;if(e&&i.wallMap){var o=this.stack;if(!o){o=[];var h={};for(var l in i.wallMap)h[l]=i.wallMap[l];var d=h["0-0"];for(o.push(d),delete h["0-0"];;){var c=d,p=c.x,u=c.y,v=null;if(!v&&h[p-1+"-"+u]&&(v=h[p-1+"-"+u],v=v.r?null:v),!v&&h[p+"-"+(u-1)]&&(v=h[p+"-"+(u-1)],v=v.b?null:v),!v&&h[p+1+"-"+u]&&(v=h[p+1+"-"+u],v=v.l?null:v),!v&&h[p+"-"+(u+1)]&&(v=h[p+"-"+(u+1)],v=v.t?null:v),v?(d=v,o.push(d),delete h[d.x+"-"+d.y]):d=o.pop(),d.x==a-1&&d.y==n-1)break}this.stack=o}t.beginPath(),t.strokeStyle=i.color,t.lineWidth=5;for(var f=o[0],m=1;m<o.length;m++){var w=o[m],y=f.x*r+r/2,g=f.y*r+r/2,b=w.x*r+r/2,k=w.y*r+r/2;t.moveTo(y,g),t.lineTo(b,k),f=w}t.stroke(),t.closePath()}}},{key:"drawWalls",value:function(t){var e=this.walls,i=this.drawSize;t.beginPath(),t.strokeStyle="blue",t.lineWidth=1.5;for(var s=0;s<i&&s<e.length;s++)this.drawWall(t,e[s]);t.stroke(),t.closePath()}},{key:"drawWall",value:function(t,e){var i=e.x,s=e.y,a=e.l,n=e.t,r=e.r,o=e.b,h=this.size.step,l=i*h+h/2,d=s*h+h/2;a&&(t.moveTo(l-h/2,d-h/2),t.lineTo(l-h/2,d+h/2)),n&&(t.moveTo(l-h/2,d-h/2),t.lineTo(l+h/2,d-h/2)),r&&(t.moveTo(l+h/2,d-h/2),t.lineTo(l+h/2,d+h/2)),o&&(t.moveTo(l-h/2,d+h/2),t.lineTo(l+h/2,d+h/2))}}]),t}(),Role=function(){function t(e){_classCallCheck(this,t);var i=e.size,s=e.timer,a=e.network;if(this.app=e,!localStorage.mazeUserName){var n=prompt("自定义姓名：");localStorage.mazeUserName=n&&n.trim().length>0?n.trim():(new NameUtil).get();var r=localStorage.mazeUserName,o=CryptoJS.SHA1(r).toString();a.addNewPlayer(r,o)}this.name=localStorage.mazeUserName,this.sha1=CryptoJS.SHA1(this.name).toString(),a.addPlayer(this.name,this.sha1),this.walls=[],this.size=i,this.timer=s,this.ArrowDown=!1,this.ArrowUp=!1,this.ArrowLeft=!1,this.ArrowRight=!1,this.posX=0,this.posY=0,this.speed=i.step/400,this.loadHead()}return _createClass(t,[{key:"reset",value:function(){this.gameover=!1,this.ArrowDown=!1,this.ArrowUp=!1,this.ArrowLeft=!1,this.ArrowRight=!1}},{key:"isVictory",value:function(){var t=this.x,e=this.y,i=this.size;return t==i.width-1&&e==i.height-1&&(this.gameover=!0),this.gameover}},{key:"loadHead",value:function(){var t=this;new UserPhoto("https://www.gravatar.com/avatar/"+this.sha1+"?s=40&d=monsterid").load(function(e,i){t.img=e,t.color=i})}},{key:"setWallMap",value:function(t){this.wallMap=t}},{key:"render",value:function(t){var e=(this.canvas,this.size),i=this.img,s=this.posX,a=this.posY;if(i){var n=e.step,r=i.width,o=i.height,h=.8*n/r,l=(n-r*h)/2,d=(n-o*h)/2;t.save(),t.translate(l,d),t.beginPath(),t.drawImage(i,s,a,r*h,o*h),t.closePath(),t.restore()}}},{key:"countPosition",value:function(){var t=this.wallMap,e=this.timer,i=this.speed,s=this.posX,a=this.posY,n=(this.canvas,this.size),r=(this.img,this.ArrowDown),o=this.ArrowUp,h=this.ArrowLeft,l=this.ArrowRight;if(t&&!this.gameover){var d=n.step;r&&(this.posY+=e.delta*i),o&&(this.posY-=e.delta*i),h&&(this.posX-=e.delta*i),l&&(this.posX+=e.delta*i);var c=parseInt((s+d/2)/d),p=parseInt((a+d/2)/d);c<0&&(c=0,this.posX=0),p<0&&(p=0,this.posY=0),c>=n.width&&(c=n.width-1,this.posX=d*c),p>=n.height&&(p=n.height-1,this.posY=d*p);var u=t[c+"-"+p],v=c*d,f=p*d;v>this.posX&&u.l&&(this.posX=v),v<this.posX&&u.r&&(this.posX=v),f>this.posY&&u.t&&(this.posY=f),f<this.posY&&u.b&&(this.posY=f),h||l||(this.oldArrowLeft&&this.posX<v&&(this.posX=v-d),this.oldArrowRight&&this.posX>v&&(this.posX=v+d)),r||o||(this.oldArrowUp&&this.posY<f&&(this.posY=f-d),this.oldArrowDown&&this.posY>f&&(this.posY=f+d)),this.oldArrowLeft=h,this.oldArrowRight=l,this.oldArrowDown=r,this.oldArrowUp=o,c=parseInt((s+d/2)/d),p=parseInt((a+d/2)/d),this.x=c,this.y=p,(this.lastX!=c&&!isNaN(c)||this.lastY!=p&&!isNaN(p))&&(this.lastX=c,this.lastY=p,this.app.network.updatePosition(this.sha1,c,p)),this.oldPosX==this.posX&&this.oldPosY==this.posY||(this.oldPosX=this.posX,this.oldPosY=this.posY,this.app.dirty=!0)}}}]),t}(),NameUtil=function(){function t(){_classCallCheck(this,t),this.nameCode="鑫正涵琛妍芸露楠薇锦彤采初美冬婧桐莲彩洁呈菡怡冰雯雪茜优静萱林馨鹤梅娜璐曼彬芳颖韵曦蔚桂月梦琪蕾依碧枫欣杉丽祥雅欢婷舒心紫芙慧梓香玥菲璟茹昭岚玲云华阳弦莉明珊雨蓓旭钰柔敏家凡花媛歆沛姿妮珍琬彦倩玉柏橘昕桃栀克帆俊惠漫芝寒诗春淑凌珠灵可格璇函晨嘉鸿瑶帛琳文洲娅霞颜康卓星礼远帝裕腾震骏加强运杞良梁逸禧辰佳子栋博年振荣国钊喆睿泽允邦骞哲皓晖福濡佑然升树祯贤成槐锐芃驰凯韦信宇鹏盛晓翰海休浩诚辞轩奇潍烁勇铭平瑞仕谛翱伟安延锋寅起谷稷胤涛弘侠峰材爵楷尧炳乘蔓桀恒桓日坤龙锟天郁吉暄澄中斌杰祜权畅德"}return _createClass(t,[{key:"get",value:function(){for(var t=[3,2,4,5][parseInt(Math.random()*Math.random()*3)],e=[];t--;)e.push(this.nameCode[parseInt(Math.random()*this.nameCode.length)]);return e.join("")}}]),t}(),Player=function(){function t(e,i){_classCallCheck(this,t);var s=e.size;this.data=i,this.size=s,this.name=i.name,this.sha1=i.sha1,this.posX=0,this.posY=0,this.loadHead()}return _createClass(t,[{key:"loadHead",value:function(){var t=this;new UserPhoto("https://www.gravatar.com/avatar/"+this.sha1+"?s=40&d=monsterid").load(function(e,i){t.img=e,t.color=i})}},{key:"render",value:function(t){var e=(this.canvas,this.size),i=this.img,s=this.x,a=this.y,n=this.data;if(i&&!(Date.now()-n.update>6e5)){var r=e.step,o=i.width,h=i.height,l=.8*r/o,d=(r-o*l)/2,c=(r-h*l)/2,p=s*r,u=a*r;t.save(),t.translate(d,c),t.beginPath(),t.drawImage(i,p,u,o*l,h*l),t.closePath(),t.restore()}}}]),t}(),Timer=function(){function t(){_classCallCheck(this,t),this.lastTime=Date.now(),this.startTime=Date.now(),this.delta=0,this.startDelta=0}return _createClass(t,[{key:"render",value:function(){this.delta=Date.now()-this.lastTime,this.startDelta=Date.now()-this.startTime,this.lastTime=Date.now()}},{key:"start",value:function(){this.delta=0,this.startTime=Date.now()}}]),t}(),Network=function(){function t(e){var i=this;_classCallCheck(this,t),this.app=e,wilddog.initializeApp({syncURL:"https://wd8264361507otxfxw.wilddogio.com"}),this.ref=wilddog.sync().ref("/maze"),window.ref=this.ref,ref.child("players").on("value",function(t){var i=t.val();for(var s in i)if(s!=e.role.sha1)if(Player.playerMap||(Player.playerMap={}),Player.playerMap[s]){var a=Player.playerMap[s];a.x==i[s].x&&a.y==i[s].y||(e.dirty=!0),a.x=i[s].x,a.y=i[s].y,a.data=i[s]}else{var n=new Player(e,i[s]);e.maze.addModel(n),Player.playerMap[s]=n,e.dirty=!0}}),this.ref.child("signal").on("value",function(t){3==t.val()&&setTimeout(function(){i.startGame()},100)}),setTimeout(function(){i.startGame()},100)}return _createClass(t,[{key:"startGame",value:function(){var t=this.app,e=this.ref;e.child("signal").set(0),e.child("players").child(t.role.sha1).transaction(function(e){return e?(t.role.posX=e.x*t.size.step,t.role.posY=e.y*t.size.step,t.role.data=e,t.dirty=!0,e):e}),e.child("walls").once("value",function(e){var i=JSON.parse(pako.inflate(e.val(),{to:"string"}));t.maze.walls=i;var s={};i.forEach(function(t){s[t.x+"-"+t.y]=t}),t.role.setWallMap(s),t.role.reset(),t.timer.start(),t.dirty=!0}),e.child("num").once("value",function(e){t.sence.level=e.val(),t.dirty=!0})}},{key:"onVictory",value:function(){var t=this.app,e=this.ref;t.role.x=0,t.role.y=0,e.child("num").transaction(function(t){return(t||0)+1}),t.maze.create(),e.child("walls").set(pako.deflate(JSON.stringify(t.maze.walls),{to:"string"})),e.child("players").child(t.role.sha1).transaction(function(t){return t.x=0,t.y=0,t.update=Date.now(),t.win++,setTimeout(function(){e.child("signal").set(3)},100),t})}},{key:"addNewPlayer",value:function(t,e){this.app;this.ref.child("players").child(e).set({name:t,sha1:e,x:0,y:0,update:Date.now(),win:0,login:0,step:0,register:Date.now()})}},{key:"addPlayer",value:function(t,e){this.app;this.ref.child("players").child(e).transaction(function(i){var s=i||{name:t,sha1:e,x:0,y:0,update:Date.now(),win:0,login:0,step:0,register:Date.now()};return s.login++,s.update=Date.now(),s})}},{key:"updatePosition",value:function(t,e,i){var s=this.app;this.ref.child("players").child(t).transaction(function(t){return t?(t.step++,t.update=Date.now(),t.x=e,t.y=i,s.role.data=t,t):t})}}]),t}(),UserPhoto=function(){function t(e){_classCallCheck(this,t),this.url=e}return _createClass(t,[{key:"load",value:function(e){var i=this;if(t.imgMap||(t.imgMap={}),t.imgMap[this.url])return void e(t.imgMap[this.url]);var s=new Image;s.src=this.url,s.crossOrigin="Anonymous",s.onload=function(){var a=document.createElement("canvas");a.width=s.width,a.height=s.height;var n=a.getContext("2d");n.drawImage(s,0,0);var r=n.getImageData(0,0,s.width,s.height),o=r.data;i.color=o.slice(0,4);for(var h=0;h<o.length;h++){var l=o[4*h+0],d=o[4*h+1],c=o[4*h+2];o[4*h+3];l==i.color[0]&&d==i.color[1]&&c==i.color[2]&&(o[4*h+3]=0)}n.putImageData(r,0,0),s.onload=function(){var a=s;t.imgMap[i.url]=a,i.color[3]=1,e(a,"rgba("+i.color.join(",")+")")},s.src=a.toDataURL()}}}]),t}(),App=function(){function t(){_classCallCheck(this,t),this.dirty=!0,this.timer=new Timer,this.network=new Network(this),this.size=new SizeUtil(this,50,30,10),this.maze=new Maze(this),this.role=new Role(this),this.sence=new Scene(this),this.rank=new Ranking(this),this.init(),this.render()}return _createClass(t,[{key:"init",value:function(){var t=this.sence,e=this.maze,i=this.role;t.addModel(e),e.addRole(i)}},{key:"render",value:function(){var t=this,e=this.sence,i=this.timer,s=this.maze,a=this.role;e.render(),i.render(),s.countState(),a.countPosition(),requestAnimationFrame(function(){t.render()})}}]),t}();new App; </script> </html>
