<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0" name="viewport">
    <title>迷宫</title>
    <script src="../js/utils/load.js" charset="utf-8"></script>
    <style media="screen">
      html, body{
        padding: 0px;
        margin: 0px;
        overflow: hidden;
      }
    </style>
  </head>
  <body>

  </body>
  <script comment="迷宫尺寸工具类" type="text/javascript">
    class SizeUtil {
      constructor(width, height, padding) {
        this.width = width
        this.height = height
        this.innerWidth = window.innerWidth
        this.innerHeight = window.innerHeight
        this.padding = padding

        var step1 = parseInt((this.innerWidth-padding*2)/this.width)
        var step2 = parseInt((this.innerHeight-padding*2)/this.height)

        this.step = Math.min(step1, step2)

        var mazeWidth = width * this.step
        var mazeHeight = height * this.step

        this.leftPadding = parseInt((this.innerWidth - mazeWidth)/2)
        this.topPadding = parseInt((this.innerHeight - mazeHeight)/2)

      }
    }
  </script>
  <script comment="场景画布" type="text/javascript">
    class Scene {
      constructor(size) {
        this.size = size
        this.canvas = document.createElement('canvas')
        this.initCanvas()
      }

      drawWalls(walls){
        const {g,canvas,size} = this
        const {leftPadding, topPadding} = size
        g.clearRect(0,0,canvas.width,canvas.height)
        g.save()
        g.translate(leftPadding,topPadding)
        g.beginPath()
        g.strokeStyle = 'blue'
        g.lineWidth = 1.5
        walls.forEach((wall)=>{
          this.drawWall(wall)
        })
        g.stroke()
        g.closePath()
        g.restore()
      }

      drawWall(wall){
        const {x,y,l,t,r,b} = wall
        const {g, size} = this
        const {step} = size
        var x_ = x * step + step/2
        var y_ = y * step + step/2
        if (l) {
          g.moveTo(x_-step/2,y_-step/2)
          g.lineTo(x_-step/2,y_+step/2)
        }
        if (t) {
          g.moveTo(x_-step/2,y_-step/2)
          g.lineTo(x_+step/2,y_-step/2)
        }
        if (r) {
          g.moveTo(x_+step/2,y_-step/2)
          g.lineTo(x_+step/2,y_+step/2)
        }
        if (b) {
          g.moveTo(x_-step/2,y_+step/2)
          g.lineTo(x_+step/2,y_+step/2)
        }
      }

      initCanvas(){
        const {canvas, size} = this
        this.g = canvas.getContext('2d')
        document.body.append(canvas)
        canvas.width = size.innerWidth
        canvas.height = size.innerHeight
        canvas.style.background = '#EEE'
      }
    }
  </script>
  <script comment="迷宫生成器" type="text/javascript">
    class WallGenerate {
      constructor(size) {
        this.walls = []
        this.width = size.width
        this.height = size.height
      }

      createWalls(){
        const {walls, width, height} = this
        var wallMap = {}
        for (var j = 0; j < height; j++) {
          for (var i = 0; i < width; i++) {
            wallMap[i+'-'+j] = { x:i, y:j, l:true, t:true, r:true, b:true }
          }
        }

        var stack = []
        var cur = wallMap['0-0']
        delete wallMap['0-0']
        cur.check = true
        cur.l=false
        wallMap[`${width-1}-${height-1}`].r=false
        walls.push(cur)
        while (true) {
          // find neighbors
          let nbs = []
          let x = cur.x
          let y = cur.y
          if (wallMap[`${x-1}-${y}`]) { nbs.push(wallMap[`${x-1}-${y}`]) }
          if (wallMap[`${x}-${y-1}`]) { nbs.push(wallMap[`${x}-${y-1}`]) }
          if (wallMap[`${x+1}-${y}`]) { nbs.push(wallMap[`${x+1}-${y}`]) }
          if (wallMap[`${x}-${y+1}`]) { nbs.push(wallMap[`${x}-${y+1}`]) }
          if (nbs.length > 0) {
            stack.push(cur)
            let o = cur
            cur = nbs[parseInt(nbs.length*Math.random())]
            walls.push(cur)
            let n = cur
            delete wallMap[`${cur.x}-${cur.y}`]
            n.check = true
            if (o.x-1==n.x) { o.l=n.r=false }
            if (o.x+1==n.x) { o.r=n.l=false }
            if (o.y-1===n.y) { o.t=n.b=false }
            if (o.y+1==n.y) { o.b=n.t=false }
          } else {
            cur = stack.pop()
            if (!cur) { break }
          }
        }

        return walls
      }

      createWallsAsync(){
        const {walls, width, height} = this

        var cur = null
        var wallMap = null
        var stack = null
        if (!this.wallMap) {
          wallMap = this.wallMap = {}
          for (var j = 0; j < height; j++) {
            for (var i = 0; i < width; i++) {
              this.wallMap[i+'-'+j] = { x:i, y:j, l:true, t:true, r:true, b:true }
            }
          }

          stack = this.stack = []
          cur = this.cur = wallMap['0-0']
          delete wallMap['0-0']
          cur.l=false
          wallMap[`${width-1}-${height-1}`].r=false
          walls.push(cur)
        }

        cur = this.cur
        wallMap = this.wallMap
        stack = this.stack

        let nbs = []
        let x = cur.x
        let y = cur.y
        if (wallMap[`${x-1}-${y}`]) { nbs.push(wallMap[`${x-1}-${y}`]) }
        if (wallMap[`${x}-${y-1}`]) { nbs.push(wallMap[`${x}-${y-1}`]) }
        if (wallMap[`${x+1}-${y}`]) { nbs.push(wallMap[`${x+1}-${y}`]) }
        if (wallMap[`${x}-${y+1}`]) { nbs.push(wallMap[`${x}-${y+1}`]) }
        if (nbs.length > 0) {
          stack.push(cur)
          let o = cur
          cur = nbs[parseInt(nbs.length*Math.random())]
          walls.push(cur)
          let n = cur
          delete wallMap[`${cur.x}-${cur.y}`]
          n.check = true
          if (o.x-1==n.x) { o.l=n.r=false }
          if (o.x+1==n.x) { o.r=n.l=false }
          if (o.y-1===n.y) { o.t=n.b=false }
          if (o.y+1==n.y) { o.b=n.t=false }
        } else {
          if (Date.now()%1000>500) {
            cur = stack.pop()
          } else {
            cur = stack.shift()
          }
          if (!cur) {
            return
          }
        }
        this.cur = cur
        return walls
      }
    }
  </script>
  <script comment="main" type="text/javascript">
    class App {
      constructor() {
        var size = new SizeUtil(40,20,40)
        this.sence = new Scene(size)
        var gengerate = new WallGenerate(size)
        var l = 0
        var loop = ()=>{
          var walls = gengerate.createWallsAsync()
          while (walls) {
            if (walls.length == l) {
              walls = gengerate.createWallsAsync()
            } else {
              l = walls.length
              break
            }
          }

          if (walls) {
            // console.log(walls.length);
            this.sence.drawWalls(walls)
            setTimeout(()=>{loop()},20)
          }
        }
        loop()
      }
    }
    new App()
  </script>
</html>
