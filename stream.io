data:application/javascript,import{Readable as e}from"node:stream";import{ReadableStream as t,WritableStream as r,TransformStream as n}from"node:stream/web";const a=2985783391;function i(e,t){if(t<0||t+4>e.length)throw new Error();return(255&e[t]|(255&e[t+1])<<8|(255&e[t+2])<<16|(255&e[t+3])<<24)>>>0}function s(e,t,r){if(r<0||r+4>e.length)throw new RangeError("Writing out of bounds");e[r]=255&t,e[r+1]=t>>8&255,e[r+2]=t>>16&255,e[r+3]=t>>24&255}function l(e){const t=e.reduce(((e,t)=>e+t.length),0),r=new Uint8Array(t);let n=0;for(const a of e)r.set(a,n),n+=a.length;return r}function o(e,t="utf-8"){return"hex"==t?Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join(""):"base64"==t?btoa(String.fromCharCode(...e)):(new TextDecoder).decode(e)}async function u(e,t,r){if(!t)return e;const n=await crypto.subtle.encrypt({name:"AES-GCM",iv:r},t,e);return new Uint8Array(n)}async function c(e,t,r){if(!t)return e;try{const n=e,a=await crypto.subtle.decrypt({name:"AES-GCM",iv:r},t,n);return new Uint8Array(a)}catch(n){}return new Uint8Array(0)}function d(e){let t=0,r=new Uint8Array(20);return s(r,e.a7,t),t+=4,s(r,e.a5,t),t+=4,s(r,e.a6,t),t+=4,s(r,e.a3,t),t+=4,s(r,e.a4,t),t+=4,l([r,e.buffer])}function w(e){let t=async function(e){if(!e)return[null,null];const t=await crypto.subtle.importKey("raw",(new TextEncoder).encode(e),"PBKDF2",!1,["deriveBits","deriveKey"]),r={name:"PBKDF2",salt:await crypto.subtle.digest("SHA-512",(new TextEncoder).encode(e)),iterations:10,hash:"SHA-256"},n=await crypto.subtle.deriveKey(r,t,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),a=await crypto.subtle.deriveBits(r,t,256);return[n,new Uint8Array(a)]}(e.a8),r=function(e){let t=null,r=null;return new n({async start(){[t,r]=await e},async transform(e,n){let i=await async function(e,t,r){let n=[];for(const i of e){let e=0,l=new Uint8Array(8),o=a,c=await u(i,t,r);s(l,c.length,e),e+=4,s(l,o,e),e+=4,n.push(l,c)}return l(n)}([e],t,r);n.enqueue(i)}})}(t),w=function(e){let t=null,r=null,s=new Uint8Array(0);return new n({async start(){[t,r]=await e},async transform(e,n){let[o,u]=await async function(e,t,r){let n=[],s=0,l=new Uint8Array(0);for(;s<e.length;){if(s+8>e.length){l=e.subarray(s);break}let o=i(e,s);s+=4;let u=i(e,s);if(s+=4,s+o>e.length){l=e.subarray(s-8);break}if(a!==u){l=new Uint8Array(0);break}let d=e.subarray(s,s+o);s+=o;let w=await c(d,t,r);w.length>0&&n.push(w)}return[n,l]}(l([s,e]),t,r);s=u;for(const t of o)n.enqueue(t)}})}(t),p=r.writable.getWriter();w.readable.pipeTo(f({async write(t){try{await async function(e,t,r){let n=function(e){let t=0,r=i(e,t);t+=4;let n=i(e,t);t+=4;let a=i(e,t);t+=4;let s=i(e,t);t+=4;let l=i(e,t);return t+=4,{a7:r,a5:n,a6:a,a3:s,a4:l,buffer:e.subarray(t)}}(r);if(3826866131==n.a7){let t=JSON.parse(o(n.buffer));e.a1.set(t.key,n.a5),n.a7=546913848,n.a6=n.a5}if(299452920==n.a7){let t=JSON.parse(o(n.buffer)),r=e.a1.get(t.key);n.a6=r,e.a2.has(r)||e.a1.delete(t.key)}let a=e.a2.get(n.a6);if(a)await a.encodeWriter.write(d(n));else{n.a7=1929208944,n.a6=n.a5,n.a4=n.a3;let r=e.a2.get(n.a6);r?await r.encodeWriter.write(d(n)):await t.write(d(n))}}(e,p,t)}catch(r){}}}));let b=e.a9++;return e.a2.set(b,{id:b,encodeWriter:p}),p.write(d({a7:2847119573,a5:0,a3:0,a6:b,a4:0,buffer:new Uint8Array(0)})),new y(b,r,w)}class y{a6=0;readable=null;writable=null;reader=null;writer=null;constructor(e,t,r){this.a6=e,this.readable=t.readable,this.writable=r.writable}}function f(e){return new r(e)}function p(r,n,a){let i=function(r){let n={a8:r.a8,a9:1,a1:/* @__PURE__ */new Map,a2:/* @__PURE__ */new Map};return(a,i)=>{if(r.path!=a.path||"POST"!=a.method)return void i();let s=w(n);s.writer=s.writable.getWriter(),s.reader=s.readable.getReader(),a.req.on("error",(e=>{})),e.toWeb(a.req).pipeTo(f({async write(e){await s.writer.write(e)}})).catch((e=>{})),a.status=200,a.response.set({"Cache-Control":"no-cache",}),a.body=e.fromWeb(new t({async pull(e){let t=await s.reader.read();e.enqueue(t.value)},cancel(){n.a2.delete(s.a6)}})).on("error",(e=>{}))}}({path:n,signal:(new AbortController).signal,a8:a});r.unshift(i)}export{p as stream};
